<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OLE Prompt Library</title>
  <link rel="stylesheet" href="src/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
  <script src="firebase-init.js"></script>
</head>
<body>
  <header>
    <div style="max-width:1100px; margin:0 auto; display:flex; justify-content:space-between; align-items:flex-start; gap:12px; padding:0 16px;">
      <!-- Auth buttons - top right -->
      <div id="authStatus" style="display:flex; flex-direction:column; align-items:flex-end; gap:4px; font-size:13px; order:2;">
        <div style="display:flex; gap:8px;">
          <button class="btn" id="authBtn" style="padding:6px 10px; font-size:12px;">Sign in with GitHub</button>
          <button class="btn" id="signOutBtn" style="padding:6px 10px; font-size:12px; background:#e74c3c; color:white; display:none;" title="Sign out">Sign Out</button>
        </div>
        <span id="userDisplay" style="display:none; font-size:11px; color:var(--muted);">
          <strong id="userName" style="cursor:pointer; text-decoration:underline;" title="Click to manage Jules API key"></strong>
        </span>
      </div>
      
      <!-- Logo and description - left side -->
      <div style="flex:1; order:1;">
        <a href="https://ole-vi.github.io/prompt-sharing/" style="text-decoration:none; color:inherit;">
          <div style="font-size:18px; font-weight:800; letter-spacing:0.2px;">OLE Prompt Library</div>
        </a>
        <div style="color:var(--muted); font-size:13px;">Single file, no build. Drop .md files in <code>/prompts</code> and they show up here.</div>
      </div>
    </div>
    
    <!-- Branch and repo controls - second row -->
    <div style="max-width:1100px; margin:8px auto 0; display:flex; justify-content:flex-end; gap:8px; padding:0 16px; align-items:center;">
      <div class="pill" id="repoPill">Loading repo...</div>
      <label style="display:flex; align-items:center; gap:4px;">
        <span title="Choose a branch">â–¼</span>
        <select id="branchSelect" class="btn" style="min-width:140px;">
          <option>Loading branchesâ€¦</option>
        </select>
      </label>
    </div>
  </header>

  <div class="wrap">
    <aside id="sidebar" class="card">
      <input id="search" placeholder="Search prompts..." />
      <button class="btn" id="freeInputBtn" title="Send a custom prompt to Jules">âœï¸ Free Input to Jules</button>
      <div id="list"></div>
      <div style="padding:8px 6px; color:var(--muted); font-size:12px;">
        Add prompts by committing <code>.md</code> files to <code>/prompts</code> in your repo. Use a first-level heading for the title.
      </div>
    </aside>

    <main id="main" class="card">
      <div id="empty">Select a prompt from the list. You can deep link to any prompt using the URL hash.</div>
      <h1 id="title" style="display:none"></h1>
      <div id="meta" style="display:none"></div>
      <div id="actions" style="display:none">
        <button class="btn" id="copyBtn" title="Copy the entire prompt">ğŸ“‹ Copy prompt</button>
        <button class="btn" id="shareBtn" title="Copy a link to this prompt">ğŸ”— Copy link</button>
        <button class="btn" id="julesBtn" title="Try this prompt in Jules">âš¡ Try in Jules</button>
        <a class="btn" id="editBtn" target="_blank" rel="noopener" title="Edit the file on GitHub">âœï¸ Edit on GitHub</a>
        <a class="btn" id="ghBtn" target="_blank" rel="noopener" title="Open the file on GitHub">ğŸ—‚ï¸ View on GitHub</a>
        <a class="btn" id="rawBtn" target="_blank" rel="noopener" title="Open raw markdown">ğŸ“„ Open raw</a>
      </div>
      <article id="content"></article>
    </main>
  </div>

  <!-- Jules API Key Modal -->
  <div id="julesKeyModal" style="display:none !important; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; flex-direction:column; align-items:center; justify-content:center;">
    <div style="background:var(--card); border:1px solid var(--border); border-radius:14px; padding:20px; max-width:400px; width:90%; box-shadow:0 8px 24px rgba(0,0,0,0.4);">
      <h2 style="margin:0 0 12px; font-size:18px;">Save Jules API Key</h2>
      <p style="margin:0 0 16px; color:var(--muted); font-size:13px;">Enter your Jules API key. This will be encrypted and stored securely.</p>
      <input id="julesKeyInput" type="password" placeholder="Paste your Jules API key..." style="width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#12162a; color:var(--text); outline:none; margin-bottom:16px; box-sizing:border-box;" />
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="julesCancelBtn" class="btn" style="padding:8px 12px;">Cancel</button>
        <button id="julesSaveBtn" class="btn" style="padding:8px 12px; border-color:var(--accent); color:var(--accent);">Save & Continue</button>
      </div>
    </div>
  </div>

  <!-- Jules Environment Modal -->
  <div id="julesEnvModal" style="display:none !important; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; flex-direction:column; align-items:center; justify-content:center;">
    <div style="background:var(--card); border:1px solid var(--border); border-radius:14px; padding:20px; max-width:400px; width:90%; box-shadow:0 8px 24px rgba(0,0,0,0.4);">
      <h2 style="margin:0 0 12px; font-size:18px;">Choose Jules Environment</h2>
      <p style="margin:0 0 16px; color:var(--muted); font-size:13px;">Which repository would you like to open?</p>
      <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:16px;">
        <button id="envPlanetBtn" class="btn" style="padding:12px; text-align:left; border:1px solid var(--border); background:transparent; cursor:pointer; border-radius:8px; font-weight:600; transition:all 0.2s;">ğŸŒ Planet</button>
        <button id="envMyplanetBtn" class="btn" style="padding:12px; text-align:left; border:1px solid var(--border); background:transparent; cursor:pointer; border-radius:8px; font-weight:600; transition:all 0.2s;">ğŸš€ MyPlanet</button>
        <button id="envMetaBtn" class="btn" style="padding:12px; text-align:left; border:1px solid var(--border); background:transparent; cursor:pointer; border-radius:8px; font-weight:600; transition:all 0.2s;">ğŸ¤– Meta</button>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="julesEnvCancelBtn" class="btn" style="padding:8px 12px;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- User Profile Modal -->
  <div id="userProfileModal" style="display:none !important; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; flex-direction:column; align-items:center; justify-content:center;">
    <div style="background:var(--card); border:1px solid var(--border); border-radius:14px; padding:20px; max-width:400px; width:90%; box-shadow:0 8px 24px rgba(0,0,0,0.4);">
      <h2 style="margin:0 0 16px; font-size:18px;">User Profile</h2>
      <div style="background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:16px;">
        <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">Signed in as</div>
        <div id="profileUserName" style="font-weight:600; font-size:14px;"></div>
      </div>
      <div id="julesKeyStatusDiv" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:16px;">
        <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">Jules API Key</div>
        <div id="julesKeyStatus" style="font-weight:600; font-size:14px; color:var(--muted);">Loading...</div>
      </div>
      <div style="display:flex; gap:8px; flex-direction:column; margin-bottom:16px;">
        <button id="addJulesKeyBtn" class="btn" style="padding:10px; border:1px solid var(--border); background:transparent; cursor:pointer; border-radius:8px; text-align:center; display:none;">â• Add Jules API Key</button>
        <button id="resetJulesKeyBtn" class="btn" style="padding:10px; border:1px solid var(--border); background:transparent; cursor:pointer; border-radius:8px; text-align:center;">ğŸ”„ Reset Jules API Key</button>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="closeProfileBtn" class="btn" style="padding:8px 12px;">Close</button>
      </div>
    </div>
  </div>

  <!-- Free Input Modal -->
  <div id="freeInputModal" class="modal">
    <div class="modal-content modal-lg">
      <h2>Free Input to Jules</h2>
      <p>Enter your custom prompt below:</p>
      <textarea id="freeInputTextarea" placeholder="Enter your prompt here..." class="modal-textarea"></textarea>
      <div class="modal-buttons">
        <button id="freeInputCancelBtn" class="btn">Cancel</button>
        <button id="freeInputSplitBtn" class="btn">âœ‚ï¸ Split into Subtasks</button>
        <button id="freeInputSubmitBtn" class="btn primary">Submit to Jules</button>
      </div>
    </div>
  </div>

  <!-- Subtask Split Modal -->
  <div id="subtaskSplitModal" class="modal">
    <div class="modal-content modal-lg">
      <h2>Break into Subtasks</h2>
      
      <!-- Subtask list for editing -->
      <div id="splitEditPanel" style="margin-bottom: 16px; border: 1px solid var(--border); border-radius: 8px; max-height: 400px; overflow-y: auto; background: rgba(255,255,255,0.02);">
        <div id="splitEditList" style="padding: 8px;"></div>
      </div>

      <div class="modal-buttons">
        <button id="splitCancelBtn" class="btn">Cancel</button>
        <button id="splitConfirmBtn" class="btn primary">Send Subtasks</button>
      </div>
    </div>
  </div>

  <!-- Subtask Error Modal -->
  <div id="subtaskErrorModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <h2 style="margin: 0 0 8px; font-size: 18px; color: #ff6b6b;">âš ï¸ Subtask Failed</h2>
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; background: rgba(255,107,107,0.1); padding: 12px; border-radius: 8px; border-left: 3px solid #ff6b6b;">
        <div style="flex: 1;">
          <div id="errorSubtaskNumber" style="font-size: 12px; color: var(--muted); margin-bottom: 4px;"></div>
          <div id="errorMessage" style="font-size: 13px; color: var(--text);"></div>
        </div>
      </div>
      <div style="margin-bottom: 16px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 12px; color: var(--muted);">
        <div id="errorDetails" style="word-break: break-word;"></div>
      </div>
      <div style="display: flex; gap: 8px; margin-bottom: 16px;">
        <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; flex: 1;">
          <input id="errorRetryDelayCheckbox" type="checkbox" checked style="cursor: pointer;" />
          <span>Wait 5 seconds before retry</span>
        </label>
      </div>
      <div class="modal-buttons" style="display: flex; gap: 8px; justify-content: flex-end;">
        <button id="subtaskErrorCancelBtn" class="btn" style="padding: 8px 16px;">Cancel All</button>
        <button id="subtaskErrorSkipBtn" class="btn" style="padding: 8px 16px; border-color: #f39c12; color: #f39c12;">Skip This</button>
        <button id="subtaskErrorRetryBtn" class="btn primary" style="padding: 8px 16px; border-color: #27ae60; background: rgba(39,174,96,0.2); color: #27ae60;">Retry</button>
      </div>
    </div>
  </div>

  <script type="module" src="src/app.js"></script>
</body>
</html>
